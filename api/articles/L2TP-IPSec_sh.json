{"title":"L2TP/IPSec一键安装脚本","uid":"730e3c222d29ca9fe69371da7aa3f4fa","slug":"L2TP-IPSec_sh","date":"2018-04-02T03:04:50.000Z","updated":"2022-06-15T08:23:47.097Z","comments":true,"path":"api/articles/L2TP-IPSec_sh.json","cover":[],"content":"<p>基于 OpenVZ 虚拟化技术的 VPS 需要开启TUN/TAP才能正常使用，购买 VPS 时请先咨询服务商是否支持开启 TUN/TAP。</p>\n<p>OpenVZ 虚拟的 VPS 需要系统内核支持 IPSec 才行。也就是说，母服务器的内核如果不支持的话那就没办法，只能换 VPS。<br>因此，一般不建议在 OpenVZ 的 VPS 上安装本脚本。脚本如果检测到该 VPS 为 OpenVZ 架构，会出现警告提醒。</p>\n<p>如何检测是否支持TUN模块？<br>执行命令：<br>cat /dev/net/tun<br>如果返回信息为：cat: /dev/net/tun: File descriptor in bad state 说明正常</p>\n<p>如何检测是否支持ppp模块？<br>执行命令：<br>cat /dev/ppp<br>如果返回信息为：cat: /dev/ppp: No such device or address 说明正常<br>当然，脚本在安装时也会执行检查，如果不适用于安装，脚本会予以提示。</p>\n<span id=\"more\"></span>\n<h2 id=\"本脚本适用环境：\"><a href=\"#本脚本适用环境：\" class=\"headerlink\" title=\"本脚本适用环境：\"></a>本脚本适用环境：</h2><p>系统支持：CentOS6+，Debian7+，Ubuntu12+<br>内存要求：≥128M<br><font color=\"red\">更新日期：2017 年 05 月 28 日</font></p>\n<h2 id=\"关于本脚本：\"><a href=\"#关于本脚本：\" class=\"headerlink\" title=\"关于本脚本：\"></a>关于本脚本：</h2><p>名词解释如下<br>L2TP（Layer 2 Tunneling Protocol）<br>IPSec（Internet Protocol Security）<br>IKEv2 (Internet Key Exchange v2)<br>能实现 IPsec 的目前总体上有 openswan，libreswan，strongswan 这3种。<br>libreswan 是基于 openswan 的 fork，所以现在各个发行版基本已经看不到 openswan 的身影了。<br>当然也有使用 strongswan 的。</p>\n<p>之所以要更新 L2TP 一键安装脚本，是因为随着各个 Linux 发行版不断推陈出新，原有的脚本已经不适应现在的需求。<br>本脚本通过编译安装最新版 libreswan 来实现 IPSec（CentOS7 下则是全部 yum 安装），yum 或 apt-get 来安装 xl2tpd，再根据各个发行版的使用方法不同，部署防火墙规则。</p>\n<h2 id=\"1-使用方法：\"><a href=\"#1-使用方法：\" class=\"headerlink\" title=\"1. 使用方法：\"></a><font color=\"red\">1. 使用方法：</font></h2><p>root 用户登录后，运行以下命令：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">wget --no-check-certificate https://raw.githubusercontent.com/teddysun/across/master/l2tp.sh\nchmod +x l2tp.sh\n./l2tp.sh</code></pre>\n\n\n<p>执行后，会有如下交互界面</p>\n<img src=\"/post/l2tp-ipsec-sh/l2tp_1.png\" class=\"\" title=\"img1\">\n\n\n<p>Please input IP-Range:<br>(Default Range: 192.168.18):<br>输入本地IP段范围（本地电脑连接到VPS后给分配的一个本地IP地址），直接回车意味着输入默认值192.168.18</p>\n<p>Please input PSK:<br>(Default PSK: teddysun.com):<br>PSK意为预共享密钥，即指定一个密钥将来在连接时需要用到，直接回车意味着输入默认值teddysun.com</p>\n<p>Please input Username:<br>(Default Username: teddysun):<br>Username意为用户名，即第一个默认用户。直接回车意味着输入默认值teddysun</p>\n<p>Please input teddysun’s password:<br>(Default Password: Q4SKhu2EXQ):<br>输入用户的密码，默认会随机生成一个10位包含大小写字母和数字的密码，当然你也可以指定密码。</p>\n<p>ServerIP:your_server_main_IP<br>显示你的 VPS 的主 IP（如果是多 IP 的 VPS 也只显示一个）</p>\n<p>Server Local IP:192.168.18.1<br>显示你的 VPS 的本地 IP（默认即可）</p>\n<p>Client Remote IP Range:192.168.18.2-192.168.18.254<br>显示 IP 段范围</p>\n<p>PSK:teddysun.com<br>显示 PSK</p>\n<p>Press any key to start…or Press Ctrl+c to cancel<br>按下任意按键继续，如果想取消安装，请按Ctrl+c键</p>\n<p>安装完成后，脚本会执行 ipsec verify 命令并提示如下：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">If there are no [FAILED] above, then you can connect to your\nL2TP VPN Server with the default Username/Password is below:\n\nServerIP:your_server_IP\nPSK:your PSK\nUsername:your usename\nPassword:your password\n\nIf you want to modify user settings, please use command(s):\nl2tp -a (Add a user)\nl2tp -d (Delete a user)\nl2tp -l (List all users)\nl2tp -m (Modify a user password)\nWelcome to visit https://teddysun.com/448.html\nEnjoy it!\n</code></pre>\n\n<p>如果你要想对用户进行操作，可以使用如下命令：<br>l2tp -a 新增用户<br>l2tp -d 删除用户<br>l2tp -m 修改现有的用户的密码<br>l2tp -l 列出所有用户名和密码<br>l2tp -h 列出帮助信息</p>\n<h2 id=\"2-注意事项：\"><a href=\"#2-注意事项：\" class=\"headerlink\" title=\"2. 注意事项：\"></a><font color=\"red\">2. 注意事项：</font></h2><p>1、错误809：<br>解决：路由线路上有防火墙没有关闭（pptp穿透防火墙的能力较差）<br>2、错误代码619<br>解决：</p>\n<pre class=\"line-numbers language-none\"><code class=\"language-none\">rm -r /dev/ppp\nmknod /dev/ppp c 108 0 \n然后重启VPS即可。</code></pre>\n<p>如果还未解决，尝试重启机器。</p>\n<p>3、要根据ppp的版本来选择对应的pptpd版本。<br>ppp-2.4.4  对应   pptpd-1.3.4<br>ppp-2.4.5  对应   pptpd-1.4.0</p>\n<h2 id=\"3-其他事项：\"><a href=\"#3-其他事项：\" class=\"headerlink\" title=\"3. 其他事项：\"></a><font color=\"red\">3. 其他事项：</font></h2><p>1、脚本在安装完成后，已自动启动进程，并加入了开机自启动。<br>2、脚本会改写 iptables 或 firewalld 的规则。<br>3、脚本安装时，会即时将安装日志写到 /root/l2tp.log 文件里，如果你安装失败，可以通过此文件来寻找错误信息。</p>\n<h2 id=\"4-使用命令：\"><a href=\"#4-使用命令：\" class=\"headerlink\" title=\"4. 使用命令：\"></a><font color=\"red\">4. 使用命令：</font></h2><p>ipsec status （查看 IPSec 运行状态）<br>ipsec verify （查看 IPSec 检查结果）<br>/etc/init.d/ipsec start|stop|restart|status （CentOS6 下使用）<br>/etc/init.d/xl2tpd start|stop|restart （CentOS6 下使用）<br>systemctl start|stop|restart|status ipsec （CentOS7 下使用）<br>systemctl start|stop|restart xl2tpd （CentOS7 下使用）<br>service ipsec start|stop|restart|status （Debian/Ubuntu 下使用）<br>service xl2tpd start|stop|restart （Debian/Ubuntu 下使用）</p>\n<h2 id=\"5-更新日志\"><a href=\"#5-更新日志\" class=\"headerlink\" title=\"5. 更新日志\"></a><font color=\"red\">5. 更新日志</font></h2><p>2017 年 05 月 28 日：<br>升级 libreswan 到版本 3.20。<br>修正 libreswan 的若干配置问题。<br>修正 xl2tpd 的端口监听配置问题。<br>修正在 CentOS 6 对 libevent2 的依赖问题，改为 yum 安装 libevent2-devel。<br>测试表明，在内网环境的 VPS 里（如AWS， IDCF，GCE，腾讯云，阿里云等）也可以正常使用了。</p>\n<p><font color=\"red\">2017 年 02 月 25 日：</font><br>升级 libreswan 到版本 3.19。</p>\n<p><font color=\"red\">2016 年 09 月 12 日：</font><br>修正了在 CentOS 6 下 libevent2 依赖的问题；<br>新增了一个 -m 选项，用以修改现有用户的密码。</p>\n<p><font color=\"red\">2016 年 08 月 13 日：</font><br>修正 Debian 8 下的 sd-daemon.h: No such file or directory 问题，是由于缺少依赖包 libsystemd-daemon-dev 导致的。</p>\n<p><font color=\"red\">2016 年 08 月 05 日：</font><br>升级 libreswan 到版本 3.18。</p>\n<p><font color=\"red\">2016 年 06 月 10 日：</font><br>脚本在安装完成后，新增了几个命令，便于操作用户<br>l2tp -a 新增用户<br>l2tp -d 删除用户<br>l2tp -l 列出所有用户<br>l2tp -h 列出帮助信息</p>\n<p>参考链接：<br><a href=\"https://libreswan.org/wiki/3.14_on_Debian_Wheezy\">https://libreswan.org/wiki/3.14_on_Debian_Wheezy</a><br><a href=\"https://github.com/libreswan/libreswan\">https://github.com/libreswan/libreswan</a></p>\n","text":"基于 OpenVZ 虚拟化技术的 VPS 需要开启TUN/TAP才能正常使用，购买 VPS 时请先咨询服务商是否支持开启 TUN/TAP。 OpenVZ 虚拟的 VPS 需要系统内核支持 IPSec 才行。也就是说，母服务器的内核如果不支持的话那就没办法，只能换 VPS。因此，一...","link":"","photos":[],"count_time":{"symbolsCount":"3.7k","symbolsTime":"3 mins."},"categories":[{"name":"VPN","slug":"VPN","count":3,"path":"api/categories/VPN.json"}],"tags":[{"name":"shadowsocks","slug":"shadowsocks","count":4,"path":"api/tags/shadowsocks.json"},{"name":"科学上网","slug":"科学上网","count":2,"path":"api/tags/科学上网.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E6%9C%AC%E8%84%9A%E6%9C%AC%E9%80%82%E7%94%A8%E7%8E%AF%E5%A2%83%EF%BC%9A\"><span class=\"toc-text\">本脚本适用环境：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E5%85%B3%E4%BA%8E%E6%9C%AC%E8%84%9A%E6%9C%AC%EF%BC%9A\"><span class=\"toc-text\">关于本脚本：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#1-%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95%EF%BC%9A\"><span class=\"toc-text\">1. 使用方法：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#2-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9%EF%BC%9A\"><span class=\"toc-text\">2. 注意事项：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#3-%E5%85%B6%E4%BB%96%E4%BA%8B%E9%A1%B9%EF%BC%9A\"><span class=\"toc-text\">3. 其他事项：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#4-%E4%BD%BF%E7%94%A8%E5%91%BD%E4%BB%A4%EF%BC%9A\"><span class=\"toc-text\">4. 使用命令：</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#5-%E6%9B%B4%E6%96%B0%E6%97%A5%E5%BF%97\"><span class=\"toc-text\">5. 更新日志</span></a></li></ol>","author":{"name":"uuxia","slug":"blog-author","avatar":"/medias/avatar.jpg","link":"/","description":"一位正在重塑知识的技术人 <br /> @ <b>欢迎光临!@</b>","socials":{"github":"https://github.com/xxl6097","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"baidu":{"icon":"/img/baidu.jpg","link":"https://www.baidu.com/my/index"}}}},"mapped":true,"prev_post":{"title":"业余时间做什么，决定了你的生活品质","uid":"22ee961dbfdc7d3a305ce1df746a4a3b","slug":"hobby","date":"2018-04-04T02:24:57.000Z","updated":"2022-02-18T10:17:37.000Z","comments":true,"path":"api/articles/hobby.json","cover":[],"text":"业余时间做什么，决定了你的生活品质 摄影看到朋友晓川发布的一条动态，配的图特别有意思，以为他去哪里旅行了。 一问才知道，他拍的地方其实只是这座城市一条不起眼的街道。 不由感叹，自己怎么就从来没有发现，这条街道还有这样美的一面。 这或许得益于晓川的摄影素养，他总能从日常生活中，发现...","link":"","photos":[],"count_time":{"symbolsCount":"1.8k","symbolsTime":"2 mins."},"categories":[{"name":"生活","slug":"生活","count":4,"path":"api/categories/生活.json"}],"tags":[{"name":"hobby","slug":"hobby","count":1,"path":"api/tags/hobby.json"},{"name":"生活","slug":"生活","count":2,"path":"api/tags/生活.json"}],"author":{"name":"uuxia","slug":"blog-author","avatar":"/medias/avatar.jpg","link":"/","description":"一位正在重塑知识的技术人 <br /> @ <b>欢迎光临!@</b>","socials":{"github":"https://github.com/xxl6097","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"baidu":{"icon":"/img/baidu.jpg","link":"https://www.baidu.com/my/index"}}}}},"next_post":{"title":"Android导入第三方静态库.a编译成动态库.so","uid":"8213f481efc903643779a1a7fd956892","slug":"android-ndk-so-a","date":"2016-05-11T15:08:51.000Z","updated":"2022-06-15T07:49:16.352Z","comments":true,"path":"api/articles/android-ndk-so-a.json","cover":[],"text":"Android导入第三方静态库.a编译成动态库.so 下面我以一个简单的实际例子来讲解如何在动态库中导入静态库。 静态库中的源代码有两个文件：static.h, static.c，有一个add方法 static.h #include &lt;stdio.h&gt; int add...","link":"","photos":[],"count_time":{"symbolsCount":"1.5k","symbolsTime":"1 mins."},"categories":[{"name":"Android","slug":"Android","count":3,"path":"api/categories/Android.json"}],"tags":[{"name":"Andorid","slug":"Andorid","count":2,"path":"api/tags/Andorid.json"},{"name":"ndk","slug":"ndk","count":2,"path":"api/tags/ndk.json"},{"name":"so","slug":"so","count":1,"path":"api/tags/so.json"},{"name":"a","slug":"a","count":1,"path":"api/tags/a.json"}],"author":{"name":"uuxia","slug":"blog-author","avatar":"/medias/avatar.jpg","link":"/","description":"一位正在重塑知识的技术人 <br /> @ <b>欢迎光临!@</b>","socials":{"github":"https://github.com/xxl6097","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{"baidu":{"icon":"/img/baidu.jpg","link":"https://www.baidu.com/my/index"}}}}}}