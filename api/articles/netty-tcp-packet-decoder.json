{"title":"netty粘包断包处理","uid":"3c34a0b2b799068430d02a7d43648438","slug":"netty-tcp-packet-decoder","date":"2022-02-18T05:22:58.000Z","updated":"2022-06-28T03:38:40.893Z","comments":true,"path":"api/articles/netty-tcp-packet-decoder.json","cover":null,"content":"<p>基于Netty的TCP Server，处理二进制数据断包和粘包，以及tcp发送字符串的截取处理！</p>\n<span id=\"more\"></span>\n\n<p>基于Netty的TCP Server，处理二进制数据断包和粘包，以及tcp发送字符串的截取处理！</p>\n<!--more-->\n\n\n<h2 id=\"一、5A协议在Netty中处理断包粘包\"><a href=\"#一、5A协议在Netty中处理断包粘包\" class=\"headerlink\" title=\"一、5A协议在Netty中处理断包粘包\"></a>一、5A协议在Netty中处理断包粘包</h2><pre class=\"line-numbers language-code\" data-language=\"code\"><code class=\"language-code\">\n   长度[2] 1  1    设备编码[8]       Mac地址[6]    帧序号[4] 保留[8]          命令字[2] Body                                                             CRC2[2]\n5A 0042   40 00   00000199000B0301 8C18D9FFEB9D 00000046 0000000000000000 0104     0000000001000301000000000000000000000003000200000000000000000000 050B\n\n说明：\n   1. 长度len=0042(HEX)=66=(34+32)不包含5A;\n   2. 空包长度total=35；\n   3. 包头5A(1byte)不算在len区；\n\n\nint maxFrameLength      = 65535;   （len是两个byte，所以最大长度是无符号两个byte的最大值）\nint lengthFieldOffset   = 1;       （len的索引下表是1，下表从0开始）\nint lengthFieldLength   = 2;       （len是两个byte）\nint lengthAdjustment    = -2;      （netty从len后面开始读取，5A不在len中，len又是2byte，所以这里是-2）\nint initialBytesToStrip = 0;       （这个0表示完整的协议内容，如果不想要5A，那么这里就是1）\n\nsocketChannel.pipeline().addLast(new LengthFieldBasedFrameDecoder(maxFrameLength, lengthFieldOffset, lengthFieldLength, lengthAdjustment, initialBytesToStrip));\n\n测试断包发送：\n完整数据包：5A0042400000000199000B03018C18D9FFEB9D00000046000000000000000001040000000001000301000000000000000000000003000200000000000000000000050B\n第一次发送（一包半）：5A0042400000000199000B03018C18D9FFEB9D00000046000000000000000001040000000001000301000000000000000000000003000200000000000000000000050B 5A0042400000000199000B03018C18D9FFEB9D0000004600000000000000000104\n第二次发送（补齐后半包）：0000000001000301000000000000000000000003000200000000000000000000050B\n<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n<h2 id=\"二、水机\"><a href=\"#二、水机\" class=\"headerlink\" title=\"二、水机\"></a>二、水机</h2><pre class=\"line-numbers language-code\" data-language=\"code\"><code class=\"language-code\">起始码  功能码 数据长度      Body                         CRC\nA2      10     0E        0102030405060708091011121314 050B\n\n\n说明：\n1.len=0E(HEX)=14,这里的len仅仅是Body的长度，不包含head的长度;\n\n\nlengthFieldOffset   = 2\nlengthFieldLength   = 1\nlengthAdjustment    = 2   \ninitialBytesToStrip = 0\nmaxFrameLength      = 255<span aria-hidden=\"true\" class=\"line-numbers-rows\"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>\n\n\n<p><a href=\"https://blog.csdn.net/lzwglory/article/details/80242209\">https://blog.csdn.net/lzwglory/article/details/80242209</a></p>\n<p><a href=\"https://blog.csdn.net/zougen/article/details/79037675\">https://blog.csdn.net/zougen/article/details/79037675</a></p>\n<p><a href=\"https://www.jianshu.com/p/a0a51fd79f62\">https://www.jianshu.com/p/a0a51fd79f62</a></p>\n<p><a href=\"https://www.cnblogs.com/workharder/p/12325908.html\">https://www.cnblogs.com/workharder/p/12325908.html</a></p>\n","text":"基于Netty的TCP Server，处理二进制数据断包和粘包，以及tcp发送字符串的截取处理！ 基于Netty的TCP Server，处理二进制数据断包和粘包，以及tcp发送字符串的截取处理！ 一、5A协议在Netty中处理断包粘包 长度[2] 1 1 设备编码[8] Mac地...","link":"","photos":[],"count_time":{"symbolsCount":"1.9k","symbolsTime":"2 mins."},"categories":[{"name":"netty","slug":"netty","count":1,"path":"api/categories/netty.json"}],"tags":[{"name":"netty","slug":"netty","count":1,"path":"api/tags/netty.json"},{"name":"tcp","slug":"tcp","count":1,"path":"api/tags/tcp.json"},{"name":"server","slug":"server","count":1,"path":"api/tags/server.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%B8%80%E3%80%815A%E5%8D%8F%E8%AE%AE%E5%9C%A8Netty%E4%B8%AD%E5%A4%84%E7%90%86%E6%96%AD%E5%8C%85%E7%B2%98%E5%8C%85\"><span class=\"toc-text\">一、5A协议在Netty中处理断包粘包</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E4%BA%8C%E3%80%81%E6%B0%B4%E6%9C%BA\"><span class=\"toc-text\">二、水机</span></a></li></ol>","author":{"name":"uuxia","slug":"blog-author","avatar":"/medias/avatar.jpg","link":"/","description":"一位正在重塑知识的技术人 <br /> @ <b>欢迎光临</b>","socials":{"github":"https://github.com/TriDiamond","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"prev_post":{"title":"Gradle发布MavenCenter和Nexus私服插件","uid":"956269ebd91624d1c17722bebe1e23da","slug":"gradle-maven","date":"2022-03-21T10:46:12.000Z","updated":"2022-07-11T04:28:14.833Z","comments":true,"path":"api/articles/gradle-maven.json","cover":[],"text":"基于Java语言与Gradle Api开发的Gradle Plugin，本Gradle插件可以让你的library发布到MavenCenter和自己的nexus私服变得非常容易。内置了阿里云Maven中央仓库，其中配置了aliyun代理的central、jcenter、googl...","link":"","photos":[],"count_time":{"symbolsCount":"3.2k","symbolsTime":"3 mins."},"categories":[{"name":"gradle","slug":"gradle","count":1,"path":"api/categories/gradle.json"},{"name":"maven","slug":"maven","count":1,"path":"api/categories/maven.json"}],"tags":[{"name":"java","slug":"java","count":2,"path":"api/tags/java.json"},{"name":"gradle","slug":"gradle","count":2,"path":"api/tags/gradle.json"},{"name":"android","slug":"android","count":4,"path":"api/tags/android.json"},{"name":"maven","slug":"maven","count":1,"path":"api/tags/maven.json"},{"name":"Kotlin","slug":"Kotlin","count":1,"path":"api/tags/Kotlin.json"}],"author":{"name":"uuxia","slug":"blog-author","avatar":"/medias/avatar.jpg","link":"/","description":"一位正在重塑知识的技术人 <br /> @ <b>欢迎光临</b>","socials":{"github":"https://github.com/TriDiamond","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}},"next_post":{"title":"树莓派设置proxy","uid":"0adae615d1625b818374c40f1991b4b1","slug":"pi-proxy","date":"2022-02-14T03:54:21.000Z","updated":"2022-06-15T07:42:58.158Z","comments":true,"path":"api/articles/pi-proxy.json","cover":null,"text":"树莓派设置proxy 设置步骤： 1. cd /etc/apt/apt.conf.d 2. sudo nano 10proxy 3. Acquire::http::Proxy \"http://192.168.31.53:1090\"; 4. reboot ","link":"","photos":[],"count_time":{"symbolsCount":130,"symbolsTime":"1 mins."},"categories":[{"name":"Raspberry","slug":"Raspberry","count":1,"path":"api/categories/Raspberry.json"},{"name":"proxy","slug":"proxy","count":2,"path":"api/categories/proxy.json"}],"tags":[{"name":"shadowsocks","slug":"shadowsocks","count":4,"path":"api/tags/shadowsocks.json"},{"name":"proxy","slug":"proxy","count":3,"path":"api/tags/proxy.json"},{"name":"raspberry","slug":"raspberry","count":1,"path":"api/tags/raspberry.json"}],"author":{"name":"uuxia","slug":"blog-author","avatar":"/medias/avatar.jpg","link":"/","description":"一位正在重塑知识的技术人 <br /> @ <b>欢迎光临</b>","socials":{"github":"https://github.com/TriDiamond","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}